<!DOCTYPE html>
<html class="page page--blog">

  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
    <meta name="viewport" content="width=device-width" />
    
    
        <meta name="description" content="When first learning about Web Sockets (something I’m still working on), I built a simple chat app. The end of last week I picked up a copy of Node.js in..." />
    
    
     
        <meta name="keywords" content="" />
    


    <title>Real Time Analytics with Node.js & Socket.io | Mark Rabey</title>

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//themes.googleusercontent.com">

    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,600italic,600,300">
    <link rel="stylesheet" href="/assets/css/font-awesome.min.css">
    <link rel="stylesheet" href="/assets/css/syntax-dark.css">
    <link rel="stylesheet" href="/assets/css/markrabey.min.css">
    
    <link rel="canonical" href="http://markrabey.com/blog/2014/05/05/real-time-analytics-with-node-js-socket-io">
    

    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@MarkRabey">
    <meta name="twitter:domain" content="markrabey.com">
    <meta name="twitter:creator" content="@MarkRabey">
    <meta name="twitter:title" content="Real Time Analytics with Node.js & Socket.io | Mark Rabey">
    <meta name="twitter:image:src" content="/logo.png">
    
        <meta name="twitter:description" content="When first learning about Web Sockets (something I’m still working on), I built a simple chat app. The end of last week I picked up a copy of Node.js in...">
    
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    
        ga('create', 'UA-45432533-2', 'auto');
        ga('send', 'pageview');
    </script>
</head>

    <body>

        <nav class="site-nav ">
    <div class="wrapper">
        <a href="/" class="site-nav__home">
            <svg class="site-nav__logo" width="44" height="44" xmlns="http://www.w3.org/2000/svg">
                <path class="site-nav__logo-fill" d="M28.716,43.987c-0.192-0.031-0.38-0.146-0.562-0.231c-0.359-0.168-0.692-0.373-1-0.63
                    c-0.308-0.256-0.564-0.642-0.769-0.945h-0.173V44h2.503C28.715,43.996,28.716,43.991,28.716,43.987z"/>
                <path class="site-nav__logo-fill" d="M12.99,35.655c-0.344-0.571-0.845-0.857-1.562-0.857c-0.484,0-0.935,0.085-1.367,0.253
                    c-0.432,0.169-0.791,0.425-1.106,0.77c-0.315,0.344-0.535,0.776-0.718,1.296c-0.184,0.52-0.217,1.132-0.217,1.835V44h5.458
                    v-6.082C13.476,36.981,13.334,36.227,12.99,35.655z"/>
                <path class="site-nav__logo-fill" d="M20.354,36.853c-0.074-0.389-0.189-0.735-0.373-1.043c-0.183-0.309-0.437-0.553-0.767-0.737
                    c-0.33-0.183-0.753-0.274-1.281-0.274c-0.615,0-1.112,0.113-1.507,0.341c-0.396,0.228-0.689,0.517-0.916,0.868
                    c-0.228,0.351-0.353,0.732-0.448,1.143c-0.096,0.41-0.071,0.799-0.071,1.164V44h5.458v-5.949
                    C20.45,37.64,20.426,37.241,20.354,36.853z"/>
                <path class="site-nav__logo-fill" d="M34.196,40.566c0.183-0.506,0.274-1.044,0.274-1.615s-0.092-1.109-0.274-1.615
                    c-0.184-0.506-0.45-0.944-0.803-1.318c-0.351-0.374-0.776-0.67-1.274-0.89c-0.498-0.221-1.055-0.33-1.669-0.33
                    c-0.602,0-1.158,0.109-1.67,0.33c-0.514,0.22-0.961,0.516-1.341,0.89c-0.382,0.374-0.682,0.812-0.901,1.318
                    s-0.329,1.044-0.329,1.615s0.109,1.109,0.329,1.615c0.22,0.505,0.52,0.944,0.901,1.318c0.38,0.373,0.827,0.67,1.341,0.89
                    c0.512,0.221,1.068,0.33,1.67,0.33c0.614,0,1.171-0.109,1.669-0.33c0.498-0.22,0.924-0.517,1.274-0.89
                    C33.746,41.511,34.013,41.071,34.196,40.566z"/>
                <path class="site-nav__logo-fill" d="M0.135,0.337V44h6.403l0.016-10.006h1.319c0.015,0.304-0.02,1.517,0.009,1.517h0.066
                    c0.263-0.304,0.703-0.965,1.318-1.367c0.616-0.403,1.333-0.532,2.153-0.532c0.674,0,1.288,0.173,1.846,0.516
                    c0.557,0.346,0.958,0.905,1.208,1.683c0.322-0.763,0.8-1.319,1.438-1.671c0.637-0.352,1.303-0.527,2.006-0.527
                    c0.791,0,1.427,0.125,1.926,0.374c0.498,0.249,0.874,0.574,1.159,0.978c0.287,0.403,0.452,0.868,0.562,1.395
                    c0.11,0.528,0.101,1.07,0.101,1.627V44h3.336V27.324h1.213v8.187h0.173c0.204-0.304,0.461-0.584,0.769-0.84s0.641-0.396,1-0.564
                    s0.736-0.294,1.132-0.374c0.396-0.081,0.783-0.121,1.165-0.121c0.776,0,1.489,0.131,2.142,0.396
                    c0.652,0.264,1.216,0.634,1.692,1.109c0.476,0.477,0.846,1.039,1.11,1.691c0.264,0.651,0.395,1.364,0.395,2.141
                    s-0.131,1.487-0.395,2.139c-0.265,0.653-0.635,1.211-1.11,1.688c-0.477,0.477-1.04,0.834-1.692,1.097
                    c-0.117,0.048-0.237,0.103-0.359,0.121c0,0.003,0,0.006,0,0.008h6.464l-0.009-10.006h1.319c0.015,0.304-0.006,1.618,0.023,1.721
                    c0.337-0.601,0.77-1.15,1.297-1.532c0.527-0.38,1.171-0.571,1.934-0.571c0.132,0,0.214,0.011,0.338,0.032
                    c0.104,0.019,0.127,0.025,0.199,0.057V0.337H0.135z"/>
                <path class="site-nav__logo-fill" d="M41.9,35.204c-0.418,0.184-0.749,0.437-1.02,0.759c-0.271,0.322-0.445,0.699-0.577,1.132
                    c-0.132,0.432-0.145,0.896-0.145,1.395V44h3.639v-8.997c-0.149-0.046-0.277-0.073-0.421-0.073
                    C42.807,34.93,42.317,35.021,41.9,35.204z"/>
            </svg>
            
                <h2 class="site-nav__title">Mark Rabey<br />Full-Stack Web Developer</h2>
            
        </a>
        <a href="#" class="site-nav__toggle" id="site-nav__toggle">Menu</a>
        <ul class="site-nav__list" id="site-nav__list">
            <li class="site-nav__item">
                <a href="/about-contact/" class="site-nav__link  site-nav__about">About &amp; Contact</a>
           

            <!-- <li class="site-nav__item">
                <a href="/services/" class="site-nav__link  site-nav__services">Services</a>
            </li> -->

            <li class="site-nav__item">
                <a href="/portfolio/" class="site-nav__link  site-nav__portfolio">Portfolio</a>
            </li> 

            <li class="site-nav__item">
                <a href="/blog/" class="site-nav__link  site-nav__blog">Blog</a>

            <!-- <li class="site-nav__item">
                <a href="/contact/" class="site-nav__link  site-nav__contact">Contact</a>
            </li> -->
        </ul>
    </div>
</nav>
<header class="page-head">
    <div class="wrapper">
        <h1 class="page-head__title">Real Time Analytics with Node.js & Socket.io</h1>
        
	<time class="page-head__date" datetime="2014-05-05">Monday, May 05, 2014</time>
        	<hr>
        
    </div>
</header>


<div class="wrapper">
    <div class="grid  grid--large">
        <div class="grid__item  grid__item--lap-and-up-one-half  grid__item--desk-two-thirds">
            <section class="post" data-ui-component="Main content">
                <p>When first learning about Web Sockets (something I’m still working on), I built a <a href="/blog/2014/04/21/simple-chat-app/">simple chat app</a>. The end of last week I picked up a copy of <em>Node.js in Action</em>. I haven’t worked through it yet, but in leafing through it I found that chapter one is…<strong><em>Building a Multi-room Chat</em></strong>. Damn. So my great learning experience was outdone in chapter one. I knew what I did was super simple, but chapter one? My idea behind the chat app was simply having a web page and the server talk back and forth in real time. It was really the simplest example I could think of, and I stand by that. Now, however, I want more. It occurred to me that while any page can connect to the server and send messages, that page doesn’t have to listen for a response. One page could listen for all responses, any not even send anything, just listen. What a great basis for real time analytics!</p>

<hr />

<h2 id="the-server">The Server</h2>
<p>The server needs to serve some static pages. For this, I used <a href="http://expressjs.com&quot;target=&quot;_blank">Express</a> with <a href="http://jade-lang.com&quot;target=&quot;_blank">Jade</a> templates. Express takes care of a lot of the basic routing for me. Making it really quick and easy to generate the basic pages I need for this project. Jade is a templating engine making it really simple to add default layouts, perfect for working with JavaScript that is the same across many pages. I’m actually not doing that yet. I could have done all this with just a few HTML pages, but I intend on expanding this project at some point, so I may as well use what I know I’ll want to anyway. I also like the clean URLs. The initial setup is very similar to that of my <a href="/blog/2014/04/21/simple-chat-app/">simple chat app</a>.</p>

<p>Assuming you’ve already <a href="https://github.com/joyent/node/wiki/installation&quot;target=&quot;_blank">installed Node.js</a>, create a folder for your project, and navigate to that folder.</p>

<p><code>mkdir realtime-analytics &amp;&amp; cd realtime-analytics</code></p>

<p>Then install the dependencies we’ll use for this project (Express, Jade, &amp; Socket.io)</p>

<p><code>npm install express jade socket.io</code></p>

<p>Next we’ll create the file <code>server.js</code> and add the code needed to serve our pages.</p>

<p>First, we include the necessary packages, and create an instance of an HTTP server:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>
  <span class="p">,</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">jade</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;jade&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">server</span><span class="p">);</span></code></pre></div>

<p>Next, we add some simple configuration for Jade. This essentially just tells Express where to find the templates, as well as creates a <code>public</code> folder for storing client-side CSS and JavaScript files.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/views&#39;</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;view engine&#39;</span><span class="p">,</span> <span class="s1">&#39;jade&#39;</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/public&#39;</span><span class="p">));</span></code></pre></div>

<p>Now, we need to create the folders <code>views</code> and <code>public</code>. Then, we’ll tell Express to serve 3 views for us: <code>index.jade</code>,<code>about.jade</code> &amp; <code>stats.jade</code>. The first 2 will be the pages that send data to the server, the 3<sup>rd</sup> will only listen to the server, and display data. We also tell the server to start listening on port 3000. You can choose another port if you prefer.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;index.jade&#39;</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/about&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;about.jade&#39;</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/stats&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;stats.jade&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span></code></pre></div>

<hr />

<h2 id="create-the-user-pages">Create the User Pages</h2>
<p>At this point I don’t really care if my pages look nice, so I’m not going to worry about that at all right now.</p>

<p>First, inside the <code>views</code> folder, create <code>index.jade</code> and add some basic code:</p>

<div class="highlight"><pre><code class="language-jade" data-lang="jade"><span class="nt">doctype</span> html
<span class="nt">html</span>
	<span class="nt">head</span>
		<span class="nt">title</span> Index | Sample Real-Time Analytics
        <span class="nt">script</span>(<span class="na">src=</span><span class="s">&#39;https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js&#39;</span>)
		<span class="nt">script</span>(<span class="na">src=</span><span class="s">&quot;/socket.io/socket.io.js&quot;</span>)
		<span class="nt">script</span>(<span class="na">src=</span><span class="s">&quot;user-script.js&quot;</span>)
	<span class="nt">body</span>
		<span class="nt">header</span>
			<span class="nt">h1</span> Index
		<span class="nt">section</span>
			<span class="nt">p</span> This is the index page. Take a look at the &lt;a href=&quot;/about&quot;&gt;about&lt;/a&gt; page.</code></pre></div>

<p>Then create the nearly identical <code>about.jade</code>:</p>

<div class="highlight"><pre><code class="language-jade" data-lang="jade"><span class="nt">doctype</span> html
<span class="nt">html</span>
	<span class="nt">head</span>
		<span class="nt">title</span> About | Sample Real-Time Analytics
		<span class="nt">script</span>(<span class="na">src=</span><span class="s">&#39;https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js&#39;</span>)
		<span class="nt">script</span>(<span class="na">src=</span><span class="s">&quot;/socket.io/socket.io.js&quot;</span>)
		<span class="nt">script</span>(<span class="na">src=</span><span class="s">&quot;user-script.js&quot;</span>)
	<span class="nt">body</span>
		<span class="nt">header</span>
			<span class="nt">h1</span> About
		<span class="nt">section</span>
			<span class="nt">p</span> This is the about page. Take a look at the &lt;a href=&quot;/&quot;&gt;index&lt;/a&gt; page.</code></pre></div>

<p>Those are the 2 pages that ideally would have a common layout, but for the purposes of this post, that’s not needed. What is important to note, is regarding the 2 JavaScript files included. First, we have <code>/socket.io/socket.io.js</code> - this file you won’t actually see in your public folder at all. The Socket.io package we included will serve this file for us. The second file, <code>user-script.js</code> we will need to create inside our <code>public</code> folder. I named it this with the idea that <code>index.jade</code> and <code>about.jade</code> are pages a ‘user’ would hit. Before creating <code>stats.jade</code>, we’ll add the code needed to listen to the ‘user’ pages.</p>

<hr />

<h2 id="configuring-socketio">Configuring Socket.io</h2>
<p>We already included the Socket.io package in our project, now we have to configure it. First, we’ll have the server listen for connections. Above <code>server.listen(3000)</code>, add:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Received message: &#39;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">);</span>
      <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;pageview&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;url&#39;</span><span class="o">:</span> <span class="nx">message</span> <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre></div>

<p>This does a couple things. First, <code>io.sockets.on('connection', function(socket)...</code> is fired every time a client connects to the server. A socket is created for communicating with the client. All other events need to happen within this one. Next, we added <code>socket.on('message', ...</code>. This has the socket listening for an event triggered by a client called <code>message</code>. When that event is fired (a message is received) the code inside is executed. In this case, we will log the message to our console, then emit an event for our stats page to listen to.</p>

<p>You should notice that in the functions are called on either <code>io.sockets</code> or <code>socket</code>. The difference is <code>io.sockets</code> listens and broadcasts to <strong>all</strong> sockets, whereas <code>socket</code> talks only to that one single socket or client.</p>

<p>Believe it or not, that’s all our sever has to do. In your Terminal window, you can type <code>node server</code> and you should see some output from Socket.io:
<img src="/content/images/blog/2014/May/Screen-Shot-2014-05-05-at-10-01-53-AM.png" alt="Server Running" /></p>

<p>As you hit the pages, you’ll see some additional output that simply says that <code>/socket.io/socket.io.js</code> has been served. At this point, we won’t see our page views logged in the console. We told the server to listen for an event called <code>message</code>, but haven’t told our pages to send that yet. To do that, create and open a file in the <code>public</code> folder called <code>user-script.js</code>, and add this code:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">);</span>
<span class="p">});</span></code></pre></div>

<p>That’s all! First, we get our socket with <code>io.connect()</code>. As soon as this is created, the <code>connect</code> event is triggered, inside of which we call <code>socket.send()</code> and pass our URL to the server. Anything passed to the server with the <code>.send()</code> function is received by the server as a <code>message</code> event.</p>

<p>Now, if you refresh one of your pages, you’ll see a lot more data being logged in the console:
<img src="/content/images/blog/2014/May/Screen-Shot-2014-05-05-at-10-11-33-AM.png" alt="Messages Logged" /></p>

<p>This is showing us all the communication between the client and the server, as well as <code>Received message: ...</code> which we told our server to log.</p>

<p>Now it’s time to create <code>stats.jade</code> so we can see what’s coming in. This needs a little more than our other 2 pages, only because we need some elements to target with JavaScript for adding data.</p>

<div class="highlight"><pre><code class="language-jade" data-lang="jade"><span class="nt">doctype</span> html
<span class="nt">html</span>
	<span class="nt">head</span>
		<span class="nt">title</span> Stats | Sample Real-Time Analytics
		<span class="nt">script</span>(<span class="na">src=</span><span class="s">&#39;https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js&#39;</span>)
		<span class="nt">script</span>(<span class="na">src=</span><span class="s">&quot;/socket.io/socket.io.js&quot;</span>)
		<span class="nt">script</span>(<span class="na">src=</span><span class="s">&quot;stat-script.js&quot;</span>)
	<span class="nt">body</span>
		<span class="nt">header</span>
			<span class="nt">h1</span> Stats
		<span class="nt">section</span>
			<span class="nt">ul</span><span class="nf">#pageviews</span></code></pre></div>

<p>Then, create and open <code>public/stat-script.js</code> and add this code:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;pageview&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#pageviews&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;&lt;li&gt;&#39;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">.</span><span class="nx">url</span> <span class="o">+</span> <span class="s1">&#39;&lt;/li&gt;&#39;</span><span class="p">);</span>
<span class="p">});</span></code></pre></div>

<p>Again, we connect to our server with <code>io.connect()</code>, but this time, we’re only targeting the <code>pageview</code> event. This is the event we told our server to emit after receiving a message from the client. All we’re doing is capturing the data from the event, and appending the URL to a list. I know it’s not pretty, but still neat. Now, open two browser windows. The first pointed to <code>http://localhost:3000/stats</code>, and the second <code>http://localhost:3000</code>, you can see this in action. Click on the ‘about’, click back to ‘index’, you’ll see these adding to the list as you click, without the stats page reloading.</p>

<p>We can easily pass along, and display other data as well. Such as IP address, the time of the connection, and the total number of connections. This is all data that can be easily retrieved from the socket objects. In <code>server.js</code> we’re going to modify <code>io.sockets.emit()</code> to look like this:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Received message: &#39;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">);</span>
      <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;pageview&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;connections&#39;</span><span class="o">:</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">io</span><span class="p">.</span><span class="nx">connected</span><span class="p">).</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;url&#39;</span><span class="o">:</span> <span class="nx">message</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span>
        <span class="s1">&#39;ip&#39;</span><span class="o">:</span><span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">address</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span>
        <span class="s1">&#39;time&#39;</span><span class="o">:</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
      <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre></div>

<p>For the number of connections, we subtract one, as our <code>stats</code> window is actually counted in that. Now that we’re passing more data, we need elements on <code>stats.jade</code> to display these in. The IP and time-stamp we can add to our existing list item, but the connection count needs an element to display in. Update <code>stats.jade</code> to look like this:</p>

<div class="highlight"><pre><code class="language-jade" data-lang="jade"><span class="nt">doctype</span> html
<span class="nt">html</span>
	<span class="nt">head</span>
		<span class="nt">title</span> Stats | Sample Real-Time Analytics
		<span class="nt">script</span>(<span class="na">src=</span><span class="s">&#39;https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js&#39;</span>)
		<span class="nt">script</span>(<span class="na">src=</span><span class="s">&quot;/socket.io/socket.io.js&quot;</span>)
		<span class="nt">script</span>(<span class="na">src=</span><span class="s">&quot;stat-script.js&quot;</span>)
	<span class="nt">body</span>
		<span class="nt">header</span>
			<span class="nt">h1</span> Stats
		<span class="nt">section</span>
			<span class="nt">ul</span><span class="nf">#pageviews</span>
		<span class="nt">section</span>
			<span class="nt">h2</span> Connections
			<span class="nf">#connections</span></code></pre></div>

<p>Then, change <code>stat-script.js</code> to display the additional data:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;pageview&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#pageviews&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;&lt;li&gt;&lt;strong&gt;URL:&lt;/strong&gt; &#39;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">.</span><span class="nx">url</span> <span class="o">+</span>
  <span class="s1">&#39;, &lt;strong&gt;IP:&lt;/strong&gt; &#39;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">.</span><span class="nx">ip</span> <span class="o">+</span>
  <span class="s1">&#39;, &lt;strong&gt;Time:&lt;/strong&gt; &#39;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">.</span><span class="nx">time</span> <span class="o">+</span> <span class="s1">&#39;&lt;/li&gt;&#39;</span><span class="p">);</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#connections&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">connections</span><span class="p">);</span>
<span class="p">});</span></code></pre></div>

<p>This is still a very crude example. Ideally the page views would be in a table, or something nicer than what I’ve done, but you get the idea. One thing I really <em>do</em> want to add at this point is a display of the current connections when the stats page is loaded. As it is right now, I have to wait for a hit to a page in order to be sent this data. Honestly, the easiest way I can think of to do this is simply emit the <code>pageview</code> event on connect. The only thing listen to it is the stats page, so why not? Inside of <code>io.sockets.on('connection'...)</code> add:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;pageview&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;connections&#39;</span><span class="o">:</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">io</span><span class="p">.</span><span class="nx">connected</span><span class="p">).</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">});</span></code></pre></div>

<p>If you restart your server and hit your stat page again, you’ll see the connections right away. But you’ll also see a bunch of <code>undefined</code> values in our page view list. So we need to update <code>stat-script.js</code> a little:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;pageview&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#pageviews&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;&lt;li&gt;&lt;strong&gt;URL:&lt;/strong&gt; &#39;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">.</span><span class="nx">url</span> <span class="o">+</span>
    <span class="s1">&#39;, &lt;strong&gt;IP:&lt;/strong&gt; &#39;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">.</span><span class="nx">ip</span> <span class="o">+</span>
    <span class="s1">&#39;, &lt;strong&gt;Time:&lt;/strong&gt; &#39;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">.</span><span class="nx">time</span> <span class="o">+</span> <span class="s1">&#39;&lt;/li&gt;&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#connections&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">connections</span><span class="p">);</span>
<span class="p">});</span></code></pre></div>

<p>This just checks that a URL was passed in <code>message</code>. If not then it won’t try to update the list of page views.</p>

<p>The project is now up on <a href="https://github.com/MarkRabey/real-time-analytics&quot;target=&quot;_blank">GitHub</a>, it will be updated, and depending on how major the updates are, I will write subsequent post explaining those steps.</p>

            </section>
            
            
                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'mrabey1983'; // required: replace example with your forum shortname

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            

        </div

        ><div class="grid__item  grid__item--lap-and-up-one-half  grid__item--desk-one-third">
            <div class="[ box  box--highlight ]  mb">
                <h3 class="heading">Related Posts</h3>
                <ul class="list-ui  post__list">
                    
                </ul>
            </div>
            
            <!-- Blog Post Skyscraper -->
            <ins class="adsbygoogle"
                 style="display:inline-block;width:300px;height:600px"
                 data-ad-client="ca-pub-1949517550744410"
                 data-ad-slot="3035177684"></ins>
            <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </div>
    </div>
</div>
<footer class="page-foot">
	
    <div class="wrapper  wrapper--full">
	    <div class="grid">
	    	<div class="grid__item">
	    		All Content &copy; 2014 Mark Rabey.
	    	</div>
	    </div>
    </div>
</footer>
<script src="/assets/js/groundwork.js" type="text/javascript"></script>
<script src="/assets/js/markrabey.js" type="text/javascript"></script>
<script src="/assets/js/highlight.pack.js" type="text/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>
        
    </body>
</html>